<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password - Vidyavantra</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }

    /* Animated background elements */
    .bg-animation {
      position: absolute;
      width: 100%;
      height: 100%;
      overflow: hidden;
      z-index: 1;
    }

    .floating-shape {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      animation: float 7s ease-in-out infinite;
    }

    .shape1 { width: 90px; height: 90px; top: 25%; left: 12%; animation-delay: 0s; }
    .shape2 { width: 130px; height: 130px; top: 65%; right: 18%; animation-delay: 2.5s; }
    .shape3 { width: 70px; height: 70px; bottom: 25%; left: 25%; animation-delay: 5s; }
    .shape4 { width: 50px; height: 50px; top: 45%; right: 30%; animation-delay: 1.5s; }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      33% { transform: translateY(-25px) rotate(120deg); }
      66% { transform: translateY(10px) rotate(240deg); }
    }

    /* Header */
    .header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 20px;
      z-index: 100;
    }

    .back-btn {
      color: white;
      text-decoration: none;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
      padding: 10px 20px;
      border-radius: 25px;
      backdrop-filter: blur(10px);
      width: fit-content;
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(-5px);
    }

    /* Reset Container */
    .reset-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 50px 40px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 480px;
      position: relative;
      z-index: 10;
      animation: slideUp 0.8s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo-section {
      text-align: center;
      margin-bottom: 40px;
    }

    .logo {
      font-size: 2.5rem;
      font-weight: bold;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .reset-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      margin: 0 auto 25px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .reset-title {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 15px;
      text-align: center;
    }

    .reset-description {
      color: #666;
      font-size: 1rem;
      line-height: 1.6;
      text-align: center;
      margin-bottom: 40px;
    }

    /* Step Indicator */
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 40px;
      gap: 15px;
    }

    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #e1e5e9;
      transition: all 0.3s ease;
    }

    .step-dot.active {
      background: linear-gradient(45deg, #667eea, #764ba2);
      transform: scale(1.2);
    }

    /* Form Steps */
    .form-step {
      display: none;
    }

    .form-step.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Form Styles */
    .form-group {
      margin-bottom: 25px;
      position: relative;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 15px 20px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: white;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }

    .form-group input:valid {
      border-color: #28a745;
    }

    /* OTP Input */
    .otp-container {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
    }

    .otp-input {
      width: 50px;
      height: 50px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      background: white;
      transition: all 0.3s ease;
    }

    .otp-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: scale(1.05);
    }

    /* Password Strength Indicator */
    .password-strength {
      margin-top: 10px;
      height: 4px;
      background: #e1e5e9;
      border-radius: 2px;
      overflow: hidden;
    }

    .strength-bar {
      height: 100%;
      width: 0%;
      transition: all 0.3s ease;
      border-radius: 2px;
    }

    .strength-weak { background: #dc3545; width: 25%; }
    .strength-fair { background: #ffc107; width: 50%; }
    .strength-good { background: #17a2b8; width: 75%; }
    .strength-strong { background: #28a745; width: 100%; }

    .strength-text {
      font-size: 0.8rem;
      margin-top: 5px;
      color: #666;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(45deg, #5a6fd8, #6a4190);
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #f8f9fa;
      color: #667eea;
      border: 2px solid #e1e5e9;
    }

    .btn-secondary:hover {
      background: #e9ecef;
      border-color: #667eea;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Timer */
    .timer {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .timer.expired {
      color: #dc3545;
    }

    /* Resend Link */
    .resend-link {
      text-align: center;
      margin-bottom: 30px;
    }

    .resend-link button {
      background: none;
      border: none;
      color: #667eea;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.9rem;
      transition: color 0.3s ease;
    }

    .resend-link button:hover {
      color: #764ba2;
    }

    .resend-link button:disabled {
      color: #ccc;
      cursor: not-allowed;
    }

    /* Success Message */
    .success-step {
      text-align: center;
      padding: 40px 20px;
    }

    .success-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(45deg, #28a745, #20c997);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: white;
      margin: 0 auto 30px;
      animation: bounce 0.6s ease;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .success-title {
      font-size: 1.8rem;
      color: #333;
      margin-bottom: 15px;
    }

    .success-message {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    /* Login Link */
    .login-link {
      text-align: center;
      color: #666;
      margin-top: 30px;
    }

    .login-link a {
      color: #667eea;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .login-link a:hover {
      color: #764ba2;
    }

    /* Error Messages */
    .error-message {
      color: #dc3545;
      font-size: 0.9rem;
      margin-top: 5px;
      display: none;
    }

    .form-group.error input {
      border-color: #dc3545;
    }

    .form-group.error .error-message {
      display: block;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .reset-container {
        margin: 20px;
        padding: 40px 30px;
      }
      
      .logo {
        font-size: 2rem;
      }
      
      .otp-container {
        gap: 10px;
      }
      
      .otp-input {
        width: 45px;
        height: 45px;
        font-size: 1.3rem;
      }
    }

    @media (max-width: 480px) {
      .reset-container {
        padding: 30px 20px;
      }
      
      .back-btn {
        font-size: 1rem;
        padding: 8px 15px;
      }
      
      .reset-icon {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Background Animation -->
  <div class="bg-animation">
    <div class="floating-shape shape1"></div>
    <div class="floating-shape shape2"></div>
    <div class="floating-shape shape3"></div>
    <div class="floating-shape shape4"></div>
  </div>

  <!-- Header -->
  <div class="header">
    <a href="/login" class="back-btn">
      ← Back to Login
    </a>
  </div>

  <!-- Reset Container -->
  <div class="reset-container">
    <div class="logo-section">
      <div class="logo">Vidyavantra</div>
    </div>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step-dot active" id="dot1"></div>
      <div class="step-dot" id="dot2"></div>
      <div class="step-dot" id="dot3"></div>
    </div>

    <!-- Step 1: Email Input -->
    <div class="form-step active" id="step1">
      <div class="reset-icon">🔐</div>
      <h2 class="reset-title">Forgot Password?</h2>
      <p class="reset-description">
        No worries! Enter your email address and we'll send you a verification code to reset your password.
      </p>

      <form id="emailForm">
        <div class="form-group">
          <label for="resetEmail">Email Address</label>
          <input type="email" id="resetEmail" name="resetEmail" placeholder="Enter your email address" required>
          <div class="error-message">Please enter a valid email address</div>
        </div>
        <button type="submit" class="btn btn-primary">Send Reset Code</button>
        <button type="button" class="btn btn-secondary" onclick="goToLogin()">Cancel</button>
      </form>
    </div>

    <!-- Step 2: OTP Verification -->
    <div class="form-step" id="step2">
      <div class="reset-icon">📧</div>
      <h2 class="reset-title">Enter Verification Code</h2>
      <p class="reset-description">
        We've sent a 6-digit verification code to <strong id="emailDisplay"></strong>. 
        Please enter the code below.
      </p>

      <form id="otpForm">
        <div class="otp-container">
          <input type="text" class="otp-input" maxlength="1" id="otp1">
          <input type="text" class="otp-input" maxlength="1" id="otp2">
          <input type="text" class="otp-input" maxlength="1" id="otp3">
          <input type="text" class="otp-input" maxlength="1" id="otp4">
          <input type="text" class="otp-input" maxlength="1" id="otp5">
          <input type="text" class="otp-input" maxlength="1" id="otp6">
        </div>
        <div class="timer" id="timer">Code expires in: <span id="countdown">05:00</span></div>
        <div class="resend-link">
          <button type="button" id="resendBtn" onclick="resendCode()" disabled>
            Didn't receive the code? Resend
          </button>
        </div>
        <button type="submit" class="btn btn-primary">Verify Code</button>
        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Change Email</button>
      </form>
    </div>

    <!-- Step 3: New Password -->
    <div class="form-step" id="step3">
      <div class="reset-icon">🔑</div>
      <h2 class="reset-title">Create New Password</h2>
      <p class="reset-description">
        Your identity has been verified. Please create a strong new password for your account.
      </p>

      <form id="passwordForm">
        <div class="form-group">
          <label for="newPassword">New Password</label>
          <input type="password" id="newPassword" name="newPassword" placeholder="Enter new password" required>
          <div class="password-strength">
            <div class="strength-bar" id="strengthBar"></div>
          </div>
          <div class="strength-text" id="strengthText">Password strength: Weak</div>
          <div class="error-message">Password must be at least 8 characters</div>
        </div>
        <div class="form-group">
          <label for="confirmNewPassword">Confirm New Password</label>
          <input type="password" id="confirmNewPassword" name="confirmNewPassword" placeholder="Confirm new password" required>
          <div class="error-message">Passwords do not match</div>
        </div>
        <button type="submit" class="btn btn-primary">Reset Password</button>
        <button type="button" class="btn btn-secondary" onclick="goToStep(2)">Back</button>
      </form>
    </div>

    <!-- Success Step -->
    <div class="form-step" id="successStep">
      <div class="success-step">
        <div class="success-icon">✓</div>
        <h3 class="success-title">Password Reset Successful!</h3>
        <p class="success-message">
          Your password has been successfully reset. You can now log in with your new password.
        </p>
        <a href="/login" class="btn btn-primary">Go to Login</a>
      </div>
    </div>

    <div class="login-link">
      Remember your password? <a href="/login">Back to Login</a>
    </div>
    </div>

  <script>
    // --- Password Reset JS with Backend Integration ---
    let currentStep = 1;
    let countdownTimer;
    let timeLeft = 300; // 5 minutes in seconds
    let resetEmail = '';
    let verifiedOtp = '';

    function goToStep(step) {
      currentStep = step;
      updateStepDisplay();
    }

    function updateStepDisplay() {
      document.querySelectorAll('.form-step').forEach(step => {
        step.classList.remove('active');
      });
      if (document.getElementById(`step${currentStep}`)) {
        document.getElementById(`step${currentStep}`).classList.add('active');
      }
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById(`dot${i}`);
        if (i <= currentStep) {
          dot.classList.add('active');
        } else {
          dot.classList.remove('active');
        }
      }
    }

    // Email form submission (send OTP)
    document.getElementById('emailForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const email = document.getElementById('resetEmail').value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        document.querySelector('#step1 .form-group').classList.add('error');
        return;
      }
      try {
        const response = await fetch('/api/send_otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await response.json();
        if (response.ok) {
          resetEmail = email;
          document.getElementById('emailDisplay').textContent = email;
          goToStep(2);
          startCountdown();
        } else {
          alert(data.message || 'Failed to send OTP');
        }
      } catch (err) {
        alert('Error sending OTP.');
      }
    });

    // OTP input setup
    function setupOTPInputs() {
      const otpInputs = document.querySelectorAll('.otp-input');
      otpInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
          if (e.target.value.length === 1 && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }
        });
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
            otpInputs[index - 1].focus();
          }
        });
      });
    }
    setupOTPInputs();

    // OTP form submission (verify OTP)
    document.getElementById('otpForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const otpValues = [];
      for (let i = 1; i <= 6; i++) {
        otpValues.push(document.getElementById(`otp${i}`).value);
      }
      const otp = otpValues.join('');
      if (otp.length !== 6) {
        alert('Please enter the complete 6-digit code');
        return;
      }
      try {
        const response = await fetch('/api/verify_otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: resetEmail, otp })
        });
        const data = await response.json();
        if (response.ok) {
          verifiedOtp = otp;
          clearInterval(countdownTimer);
          goToStep(3);
        } else {
          alert(data.message || 'Invalid OTP');
        }
      } catch (err) {
        alert('Error verifying OTP.');
      }
    });

    // Password strength checker
    function checkPasswordStrength(password) {
      let strength = 0;
      let strengthText = 'Weak';
      let strengthClass = 'strength-weak';
      if (password.length >= 8) strength++;
      if (/[a-z]/.test(password)) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;
      switch (strength) {
        case 0:
        case 1:
          strengthText = 'Weak';
          strengthClass = 'strength-weak';
          break;
        case 2:
          strengthText = 'Fair';
          strengthClass = 'strength-fair';
          break;
        case 3:
          strengthText = 'Good';
          strengthClass = 'strength-good';
          break;
        case 4:
        case 5:
          strengthText = 'Strong';
          strengthClass = 'strength-strong';
          break;
      }
      return { strengthText, strengthClass };
    }

    // Password form submission (reset password)
    document.getElementById('passwordForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmNewPassword').value;
      let isValid = true;
      document.querySelectorAll('#step3 .form-group').forEach(group => {
        group.classList.remove('error');
      });
      if (newPassword.length < 8) {
        document.querySelector('#newPassword').closest('.form-group').classList.add('error');
        isValid = false;
      }
      if (newPassword !== confirmPassword) {
        document.querySelector('#confirmNewPassword').closest('.form-group').classList.add('error');
        isValid = false;
      }
      if (!isValid) return;
      try {
        const response = await fetch('/api/reset_password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: resetEmail, otp: verifiedOtp, new_password: newPassword })
        });
        const data = await response.json();
        if (response.ok) {
          document.getElementById('successStep').classList.add('active');
          document.getElementById('step3').classList.remove('active');
        } else {
          alert(data.message || 'Failed to reset password');
        }
      } catch (err) {
        alert('Error resetting password.');
      }
    });

    // Countdown timer
    function startCountdown() {
      timeLeft = 300;
      document.getElementById('resendBtn').disabled = true;
      document.getElementById('timer').classList.remove('expired');
      countdownTimer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        document.getElementById('countdown').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        if (timeLeft <= 0) {
          clearInterval(countdownTimer);
          document.getElementById('timer').classList.add('expired');
          document.getElementById('countdown').textContent = 'Expired';
          document.getElementById('resendBtn').disabled = false;
        }
        timeLeft--;
      }, 1000);
    }

    // Resend code
    async function resendCode() {
      if (!resetEmail) return;
      try {
        const response = await fetch('/api/send_otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: resetEmail })
        });
        const data = await response.json();
        if (response.ok) {
          alert('Verification code resent to your email!');
          startCountdown();
        } else {
          alert(data.message || 'Failed to resend code');
        }
      } catch (err) {
        alert('Error resending code.');
      }
    }

    // Go to login
    function goToLogin() {
      window.location.href = '/login';
    }

    // Password strength indicator
    document.getElementById('newPassword').addEventListener('input', function() {
      const password = this.value;
      const strengthBar = document.getElementById('strengthBar');
      const strengthText = document.getElementById('strengthText');
      const { strengthText: text, strengthClass } = checkPasswordStrength(password);
      strengthBar.className = `strength-bar ${strengthClass}`;
      strengthText.textContent = `Password strength: ${text}`;
    });

    // Confirm password validation
    document.getElementById('confirmNewPassword').addEventListener('input', function() {
      const password = document.getElementById('newPassword').value;
      const formGroup = this.closest('.form-group');
      if (this.value === password) {
        formGroup.classList.remove('error');
      } else {
        formGroup.classList.add('error');
      }
    });

    // Real-time email validation
    document.getElementById('resetEmail').addEventListener('input', function() {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const formGroup = this.closest('.form-group');
      if (emailRegex.test(this.value)) {
        formGroup.classList.remove('error');
      }
    });

    // Add floating animation to background shapes
    document.addEventListener('mousemove', function(e) {
      const shapes = document.querySelectorAll('.floating-shape');
      const x = e.clientX / window.innerWidth;
      const y = e.clientY / window.innerHeight;
      shapes.forEach((shape, index) => {
        const speed = (index + 1) * 0.4;
        const xPos = x * speed * 12;
        const yPos = y * speed * 12;
        shape.style.transform += ` translate(${xPos}px, ${yPos}px)`;
      });
    });
  </script>

</body>
</html>